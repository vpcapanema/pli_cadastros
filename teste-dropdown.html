<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Dropdown API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Teste de Dropdown API</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome Completo</label>
                                <select class="form-select" id="nome" name="nome">
                                    <option value="">Carregando pessoas físicas...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="instituicao_nome" class="form-label">Instituição</label>
                                <select class="form-select" id="instituicao_nome" name="instituicao_nome">
                                    <option value="">Carregando instituições...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" onclick="loadData()">Recarregar Dados</button>
                            <button type="button" class="btn btn-secondary" onclick="showLogs()">Mostrar Logs</button>
                        </div>
                        <div id="logs" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Array para armazenar logs
        const debugLogs = [];
        
        function log(message) {
            console.log(message);
            debugLogs.push(new Date().toLocaleTimeString() + ': ' + message);
        }
        
        function showLogs() {
            document.getElementById('logs').innerHTML = '<pre class="bg-dark text-light p-3">' + debugLogs.join('\n') + '</pre>';
        }

        // API Service simplificado
        const API = {
            baseUrl: '/api',
            
            async get(endpoint) {
                try {
                    const url = `${window.location.origin}${this.baseUrl}${endpoint}`;
                    log(`Fazendo requisição para: ${url}`);
                    
                    const token = localStorage.getItem('token');
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao realizar requisição');
                    }
                    
                    const data = await response.json();
                    log(`Dados recebidos: ${data.length} registros`);
                    return data;
                } catch (error) {
                    log(`Erro na requisição: ${error.message}`);
                    throw error;
                }
            }
        };

        async function loadPessoasFisicas() {
            try {
                log('Iniciando loadPessoasFisicas...');
                
                const selectNome = document.getElementById('nome');
                log(`Select nome encontrado: ${selectNome ? 'SIM' : 'NÃO'}`);
                
                if (!selectNome) {
                    log('Select #nome não encontrado!');
                    return;
                }
                
                const pessoasFisicas = await API.get('/pessoas-fisicas');
                
                // Limpa as opções existentes
                selectNome.innerHTML = '<option value="">Selecione uma pessoa física cadastrada</option>';
                log('Select limpo');
                
                // Adiciona as pessoas físicas
                pessoasFisicas.forEach((pessoa, index) => {
                    const option = document.createElement('option');
                    option.value = pessoa.id;
                    option.textContent = pessoa.nome_completo;
                    selectNome.appendChild(option);
                    log(`Adicionada pessoa ${index + 1}: ${pessoa.nome_completo}`);
                });
                
                log(`Total de opções no select: ${selectNome.options.length}`);
            } catch (error) {
                log(`Erro ao carregar pessoas físicas: ${error.message}`);
            }
        }

        async function loadInstituicoes() {
            try {
                log('Iniciando loadInstituicoes...');
                
                const selectInstituicao = document.getElementById('instituicao_nome');
                log(`Select instituicao_nome encontrado: ${selectInstituicao ? 'SIM' : 'NÃO'}`);
                
                if (!selectInstituicao) {
                    log('Select #instituicao_nome não encontrado!');
                    return;
                }
                
                const instituicoes = await API.get('/instituicoes');
                
                // Limpa as opções existentes
                selectInstituicao.innerHTML = '<option value="">Selecione uma instituição</option>';
                log('Select instituição limpo');
                
                // Adiciona as instituições
                instituicoes.forEach((instituicao, index) => {
                    const option = document.createElement('option');
                    option.value = instituicao.id;
                    option.textContent = instituicao.razao_social;
                    selectInstituicao.appendChild(option);
                    log(`Adicionada instituição ${index + 1}: ${instituicao.razao_social}`);
                });
                
                log(`Total de opções no select instituição: ${selectInstituicao.options.length}`);
            } catch (error) {
                log(`Erro ao carregar instituições: ${error.message}`);
            }
        }

        async function loadData() {
            debugLogs.length = 0; // Limpa os logs
            await loadPessoasFisicas();
            await loadInstituicoes();
            showLogs();
        }

        // Carrega os dados automaticamente quando a página carrega
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM carregado, iniciando carregamento...');
            loadData();
        });
    </script>
</body>
</html>
