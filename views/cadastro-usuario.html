<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Usuário - SIGMA-PLI | Módulo de Gerenciamento de Cadastros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/sistema_aplicacao_cores_pli.css">
    <style>
        .is-valid-form {
            box-shadow: 0 0 0 2px #19875444 !important;
        }
        .form-section {
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .form-section-header {
            background: var(--pli-azul-escuro);
            color: white;
            padding: 1rem;
            font-weight: 600;
        }
        .form-section-body {
            background: #fff;
            padding: 1.5rem;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .password-strength-text {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        .captcha-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }
        .verificacao-seguranca-input {
            font-size: 1.1rem;
            font-weight: 500;
            display: inline-block;
        }
        .verificacao-seguranca-label {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <div id="navbar-container"></div>
    <script src="/static/js/navbar-loader.js"></script>
    
   
        
    <!-- Placeholder para o navbar original -->
    <nav class="navbar d-none">
        <div class="container">
            <a class="navbar-brand pli-navbar-brand" href="index.html">
                <i class="fas fa-building me-2"></i>
                <span class="fw-bold">Programa de Legalização de Imóveis</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Início
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cadastro-pessoa-fisica.html">
                            <i class="fas fa-user"></i> Cadastro PF
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cadastro-pessoa-juridica.html">
                            <i class="fas fa-building"></i> Cadastro PJ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="cadastro-usuario.html">
                            <i class="fas fa-user-plus"></i> Cadastro Usuário
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Área Central -->
    <div class="flex-grow-1 py-5 pli-bg-gradient">
        <div class="container pli-main-content pli-max-width-600">

            <!-- Título da Página -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="mb-0 pli-title">
                        <i class="fas fa-user-plus me-2 text-pli-primary"></i>
                        Cadastro de Usuário
                    </h1>
                    <p class="text-muted">Solicite seu acesso ao sistema PLI</p>
                </div>
            </div>

            <!-- Alerta Informativo -->
            <div class="row justify-content-center mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Para solicitar acesso, é necessário cadastre-se primeiro como Pessoa Física e em seguida cadastrar a instituição (Pessoa Jurídica) à qual você está vinculado.
                    </div>
                </div>
            </div>

            <!-- Formulário -->
            <div class="row justify-content-center">
                <div class="col-12">
                    <form id="usuarioPublicForm" novalidate>
                        <!-- Dados Pessoais -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-id-card me-2"></i> Dados Pessoais
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="nome" class="form-label required-field">Nome Completo</label>
                                        <select class="form-select" id="nome" name="nome" required aria-describedby="nome-help">
                                            <option value="">Selecione uma pessoa física cadastrada</option>
                                            <!-- Opções serão carregadas via JavaScript -->
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione uma pessoa física.</div>
                                        <div id="nome-help" class="form-text">Selecione uma pessoa física já cadastrada no sistema.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="idPessoaFisica" class="form-label required-field">ID Pessoa Física</label>
                                        <input type="text" class="form-control" id="idPessoaFisica" name="pessoa_fisica_id" required readonly>
                                        <div class="invalid-feedback">O ID da pessoa física é obrigatório.</div>
                                        <div class="form-text">Este é o identificador único da pessoa física selecionada.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label required-field">Email</label>
                                        <input type="email" class="form-control" id="email" name="email" required readonly>
                                        <div class="invalid-feedback">Por favor, informe um email válido.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="telefone" class="form-label required-field">Telefone</label>
                                        <input type="text" class="form-control" id="telefone" name="telefone" required readonly>
                                        <div class="invalid-feedback">Por favor, informe um telefone válido.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="documento" class="form-label required-field">CPF</label>
                                        <input type="text" class="form-control" id="documento" name="documento" required readonly>
                                        <div class="invalid-feedback">Por favor, informe um CPF válido.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados Profissionais -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-briefcase me-2"></i> Dados Profissionais
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="instituicao_nome" class="form-label required-field">Instituição</label>
                                        <select class="form-select" id="instituicao_nome" name="instituicao_nome" required>
                                            <option value="">Selecione uma instituição</option>
                                            <!-- Opções serão carregadas via JavaScript -->
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione uma instituição.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="idPessoaJuridica" class="form-label required-field">ID Pessoa Jurídica</label>
                                        <input type="text" class="form-control" id="idPessoaJuridica" name="pessoa_juridica_id" required readonly>
                                        <div class="invalid-feedback">O ID da pessoa jurídica é obrigatório.</div>
                                        <div class="form-text">Identificador único da instituição.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="departamento" class="form-label">Departamento</label>
                                        <input type="text" class="form-control" id="departamento" name="departamento">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cargo" class="form-label">Cargo</label>
                                        <input type="text" class="form-control" id="cargo" name="cargo">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email_institucional" class="form-label required-field">E-mail Institucional</label>
                                        <input type="email" class="form-control" id="email_institucional" name="email_institucional" required>
                                        <div class="invalid-feedback">Por favor, informe um e-mail institucional válido.</div>
                                        <div class="form-text">O nome de usuário será gerado automaticamente a partir deste e-mail.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="telefone_institucional" class="form-label">Telefone Institucional</label>
                                        <input type="text" class="form-control" id="telefone_institucional" name="telefone_institucional">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ramal_institucional" class="form-label">Ramal Institucional</label>
                                        <input type="text" class="form-control" id="ramal_institucional" name="ramal_institucional">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dados de Acesso -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-lock me-2"></i> Dados de Acesso
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="tipo_usuario" class="form-label required-field">Tipo de Usuário</label>
                                        <select class="form-select" id="tipo_usuario" name="tipo_usuario" required aria-describedby="tipo-usuario-help">
                                            <option value="">Selecione</option>
                                            <option value="ADMIN">Administrador</option>
                                            <option value="GESTOR">Gestor</option>
                                            <option value="ANALISTA">Analista</option>
                                            <option value="OPERADOR">Operador</option>
                                            <option value="VISUALIZADOR">Visualizador</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione um tipo de usuário.</div>
                                        <div id="tipo-usuario-help" class="form-text">
                                            Você pode ter até cinco usuários diferentes (um de cada tipo) com o mesmo CPF.
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="username" class="form-label required-field">Nome de Usuário</label>
                                        <input type="text" class="form-control" id="username" name="username" required readonly>
                                        <div class="invalid-feedback">Nome de usuário é obrigatório.</div>
                                        <div class="form-text">Gerado automaticamente a partir do e-mail institucional.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="senha" class="form-label required-field">Senha</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="senha" name="senha" required aria-describedby="toggleSenha">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleSenha" tabindex="-1" aria-label="Mostrar/ocultar senha"><i class="fa fa-eye"></i></button>
                                        </div>
                                        <div class="password-strength" id="passwordStrength"></div>
                                        <div class="password-strength-text" id="passwordStrengthText"></div>
                                        <div class="invalid-feedback" id="senhaFeedback">Por favor, crie uma senha forte.</div>
                                        <div class="form-text">
                                            A senha deve conter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e caracteres especiais.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confirmarSenha" class="form-label required-field">Confirmar Senha</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha" required aria-describedby="toggleConfirmarSenha">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarSenha" tabindex="-1" aria-label="Mostrar/ocultar senha"><i class="fa fa-eye"></i></button>
                                        </div>
                                        <div class="invalid-feedback" id="confirmarSenhaFeedback">As senhas não coincidem.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Termos e Condições -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-file-signature me-2"></i> Termos e Condições
                            </div>
                            <div class="form-section-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termoPrivacidade" name="termo_privacidade" required>
                                    <label class="form-check-label" for="termoPrivacidade">
                                        Li e concordo com a <a href="#" data-bs-toggle="modal" data-bs-target="#privacidadeModal">Política de Privacidade</a> *
                                    </label>
                                    <div class="invalid-feedback">Você deve concordar com a política de privacidade.</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termoUso" name="termo_uso" required>
                                    <label class="form-check-label" for="termoUso">
                                        Li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termosModal">Termos de Uso</a> *
                                    </label>
                                    <div class="invalid-feedback">Você deve concordar com os termos de uso.</div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <small>Ao solicitar acesso, você declara que as informações fornecidas são verdadeiras e está ciente de que o uso indevido do sistema pode resultar em sanções administrativas e legais.</small>
                                </div>
                            </div>
                        </div>
                    <!-- Botões em linha separada -->
                        <div class="row mt-2">
                            <div class="col-6 d-flex justify-content-start">
                                <button type="button" class="btn btn-secondary btn-lg px-4 w-100" onclick="window.location.href='index.html'">
                                    <i class="fas fa-arrow-left me-2"></i> Voltar
                                </button>
                            </div>
                            <div class="col-6 d-flex flex-column align-items-end">
                                <button type="submit" class="btn btn-primary btn-lg px-4 w-100">
                                    <i class="fas fa-user-plus me-2"></i> Solicitar Acesso
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Política de Privacidade -->
    <div class="modal fade" id="privacidadeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt me-2"></i> Política de Privacidade
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Coleta de Dados</h6>
                    <p>Coletamos informações pessoais como nome, email e telefone para fins de cadastro no sistema PLI.</p>
                    
                    <h6>2. Uso dos Dados</h6>
                    <p>Seus dados serão utilizados exclusivamente para:</p>
                    <ul>
                        <li>Identificação e autenticação no sistema</li>
                        <li>Comunicação sobre seu cadastro e processos relacionados</li>
                        <li>Cumprimento de obrigações legais</li>
                    </ul>
                    
                    <h6>3. Armazenamento</h6>
                    <p>Seus dados são armazenados em servidores seguros e protegidos por medidas técnicas adequadas.</p>
                    
                    <h6>4. Compartilhamento</h6>
                    <p>Não compartilhamos seus dados com terceiros, exceto quando exigido por lei.</p>
                    
                    <h6>5. Seus Direitos</h6>
                    <p>Você tem direito a acessar, corrigir e solicitar a exclusão dos seus dados, conforme a Lei Geral de Proteção de Dados (LGPD).</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-lg px-4" data-bs-dismiss="modal">>Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Termos de Uso -->
    <div class="modal fade" id="termosModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-contract me-2"></i> Termos de Uso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Aceitação dos Termos</h6>
                    <p>Ao utilizar o Sistema PLI, você concorda com estes termos de uso.</p>
                    
                    <h6>2. Cadastro</h6>
                    <p>Você é responsável por fornecer informações verdadeiras e manter seus dados atualizados.</p>
                    
                    <h6>3. Uso do Sistema</h6>
                    <p>O sistema deve ser utilizado apenas para os fins a que se destina, sendo proibido:</p>
                    <ul>
                        <li>Utilizar dados falsos</li>
                        <li>Tentar acessar áreas restritas sem autorização</li>
                        <li>Realizar ações que possam danificar ou sobrecarregar o sistema</li>
                        <li>Compartilhar suas credenciais de acesso com terceiros</li>
                    </ul>
                    
                    <h6>4. Responsabilidades</h6>
                    <p>Você é responsável por todas as atividades realizadas com seu cadastro.</p>
                    
                    <h6>5. Alterações nos Termos</h6>
                    <p>Estes termos podem ser alterados a qualquer momento, sendo sua responsabilidade verificá-los periodicamente.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-lg px-4" data-bs-dismiss="modal">>Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success">
                        <i class="fas fa-check-circle me-2"></i> Solicitação Enviada com Sucesso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-check-circle text-success pli-icon-4rem"></i>
                    </div>
                    
                    <div class="alert alert-success">
                        <h4 class="alert-heading">Solicitação Recebida!</h4>
                        <p>Sua solicitação de acesso foi recebida com sucesso!</p>
                        <hr>
                        <p class="mb-0"><strong>Protocolo:</strong> <span id="protocoloSolicitacao">PLI-XXXXXXXX</span></p>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-envelope me-2"></i> Notificações
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><i class="fas fa-paper-plane me-2 text-primary"></i> Um email de confirmação foi <span id="emailStatus">enviado</span> para os endereços informados.</p>
                            <p><i class="fas fa-file-alt me-2 text-primary"></i> O comprovante da solicitação foi anexado ao email.</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tasks me-2"></i> Próximos Passos
                            </h5>
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li><strong>Etapa Atual:</strong> <span class="badge bg-success">Solicitação Recebida</span></li>
                                <li><strong>Próxima Etapa:</strong> <span class="badge bg-warning text-dark">Em Análise</span> - Sua solicitação será analisada pelos administradores ou gestores do sistema.</li>
                                <li><strong>Etapa Final:</strong> <span class="badge bg-info">Aprovação/Rejeição</span> - Você receberá um email com o resultado da análise.</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        O prazo médio para análise é de 2 dias úteis. Em caso de dúvidas, entre em contato pelo email <strong>pli.semil.sp@gmail.com</strong>.
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="index.html" class="btn btn-primary btn-lg px-4">
                        <i class="fas fa-home me-2"></i> Ir para Página Inicial
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container">
        <!-- O footer será carregado aqui via JavaScript -->
    </div>
    
    <script>
        // Mostrar/ocultar senha
        document.getElementById('toggleSenha').addEventListener('click', function() {
            const senhaInput = document.getElementById('senha');
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
                this.innerHTML = '<i class="fa fa-eye-slash"></i>';
            } else {
                senhaInput.type = 'password';
                this.innerHTML = '<i class="fa fa-eye"></i>';
            }
        });
        document.getElementById('toggleConfirmarSenha').addEventListener('click', function() {
            const confirmarSenhaInput = document.getElementById('confirmarSenha');
            if (confirmarSenhaInput.type === 'password') {
                confirmarSenhaInput.type = 'text';
                this.innerHTML = '<i class="fa fa-eye-slash"></i>';
            } else {
                confirmarSenhaInput.type = 'password';
                this.innerHTML = '<i class="fa fa-eye"></i>';
            }
        });
        // Carrega o footer compartilhado
        document.addEventListener('DOMContentLoaded', function() {
            // Validação do formulário (declarar antes de qualquer uso)
            const form = document.getElementById('usuarioPublicForm');
            // Tenta carregar o footer de um caminho alternativo se o padrão falhar
            function carregarFooter(caminho) {
                fetch(caminho)
                    .then(response => {
                        if (!response.ok) throw new Error('404');
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('footer-container').innerHTML = html;
                    })
                    .catch(error => {
                        if (caminho === '/views/components/footer.html') {
                            // Tenta caminho alternativo se o padrão falhar
                            carregarFooter('/static/views/components/footer.html');
                        } else {
                            console.error('Erro ao carregar footer:', error);
                        }
                    });
            }
            carregarFooter('/views/components/footer.html');
        });
    </script>
    
    <!-- Placeholder para o footer original -->
    <footer class="d-none pli-footer py-3 mt-auto">
        <div class="container">
            <div class="row align-items-center">
                <!-- Informações do sistema -->
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-building me-2 text-pli-primary"></i>
                            <span class="fw-bold text-white">Programa de Legalização de Imóveis</span>
                            <small class="ms-2 text-muted">v2.0.0</small>
                        </div>
                        <small class="text-muted">
                            © 2025 Secretaria Municipal de Habitação - Programa de Legalização de Imóveis. Todos os direitos reservados.
                        </small>
                    </div>
                </div>

                <!-- Links úteis e informações -->
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end align-items-center">
                        <a href="#" class="text-light me-3" title="Ajuda">
                            <i class="fas fa-question-circle"></i>
                        </a>
                        <a href="#" class="text-light me-3" title="Suporte">
                            <i class="fas fa-life-ring"></i>
                        </a>
                        <a href="#" class="text-light" title="Documentação">
                            <i class="fas fa-book"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <!-- Scripts da aplicação -->
    <script src="/js/services/api.js"></script>
    <script src="/js/components/form-validator.js"></script>
    <script src="/static/js/components/anti-bot.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Declarar form no topo para escopo global do DOMContentLoaded
            const form = document.getElementById('usuarioPublicForm');
            // Área de logs em tempo real
            let logArea = document.getElementById('log-area');
            if (!logArea) {
                logArea = document.createElement('div');
                logArea.id = 'log-area';
                logArea.style.background = '#222';
                logArea.style.color = '#fff';
                logArea.style.fontSize = '0.95em';
                logArea.style.padding = '10px 15px';
                logArea.style.margin = '20px 0 10px 0';
                logArea.style.borderRadius = '6px';
                logArea.style.maxHeight = '180px';
                logArea.style.overflowY = 'auto';
                logArea.style.display = 'none';
                form.parentNode.insertBefore(logArea, form.nextSibling);
            }
            // Exibe logs apenas após o clique em Solicitar Acesso
            function log(msg, type = 'info') {
                const time = new Date().toLocaleTimeString();
                const color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#51cf66' : '#fff');
                logArea.innerHTML += `<div style='color:${color}'>[${time}] ${msg}</div>`;
                logArea.scrollTop = logArea.scrollHeight;
                if (window.console) {
                    if (type === 'error') {
                        // Se for HTML, remove tags para o terminal
                        const plainMsg = msg.replace ? msg.replace(/<[^>]+>/g, '') : msg;
                        console.error('[LOG-ERRO]', plainMsg);
                        // Se houver detalhes de campos inválidos, logar cada um
                        if (typeof msg === 'string' && msg.includes('Dados inválidos')) {
                            // Extrai campos do HTML se possível
                            const matches = msg.match(/<li><strong>([^<]+):<\/strong> ([^<]+)<\/li>/g);
                            if (matches) {
                                matches.forEach(item => {
                                    const campo = item.replace(/<[^>]+>/g, '').trim();
                                    console.error('[CAMPO INVÁLIDO]', campo);
                                });
                            }
                        }
                    } else if (type === 'success') {
                        console.log('%c' + msg, 'color: #51cf66');
                    } else {
                        console.log(msg);
                    }
                }
            }
            // Oculta a área de logs até o envio
            logArea.style.display = 'none';
            // Inicializa proteção anti-bot
            let antiBotProtection;
            try {
                antiBotProtection = new AntiBotProtection('usuarioPublicForm');
                log('Proteção anti-bot inicializada.');
            } catch (error) {
                log('Erro ao inicializar proteção anti-bot: ' + error, 'error');
            }
            // Carrega pessoas físicas e instituições
            carregarPessoasFisicas();
            carregarInstituicoes();
            log('Campos de pessoas físicas e instituições carregados.');
            // Configura o campo ativo com valor padrão false
            const campoAtivo = document.createElement('input');
            campoAtivo.type = 'hidden';
            campoAtivo.name = 'ativo';
            campoAtivo.value = 'false';
            form.appendChild(campoAtivo);
            // Inicializa máscaras
            setTimeout(function() {
                if (window.jQuery && $.fn.mask) {
                    $('#telefone_institucional').mask('(00) 00000-0000');
                    $('#ramal_institucional').mask('0000');
                    log('Máscaras aplicadas nos campos de telefone e ramal.');
                } else {
                    log('jQuery ou jQuery Mask não estão disponíveis', 'error');
                }
            }, 500);
            // Configura evento para extrair username do email institucional
            document.getElementById('email_institucional').addEventListener('input', function() {
                const email = this.value;
                const username = email.split('@')[0];
                document.getElementById('username').value = username;
                log('Username atualizado para: ' + username);
            });
            // Configura evento de mudança na seleção de pessoa física
            document.getElementById('nome').addEventListener('change', function() {
                const pessoaId = this.value;
                if (pessoaId) {
                    carregarDadosPessoaFisica(pessoaId);
                    log('Pessoa física selecionada: ' + pessoaId);
                } else {
                    // Limpa os campos
                    document.getElementById('email').value = '';
                    document.getElementById('telefone').value = '';
                    document.getElementById('documento').value = '';
                    document.getElementById('idPessoaFisica').value = '';
                    log('Seleção de pessoa física limpa.');
                }
            });
            
            /**
             * Carrega lista de pessoas físicas do banco de dados
             */
            function carregarPessoasFisicas() {
                // Buscar pessoas físicas reais da API
                fetch('/api/pessoas-fisicas')
                    .then(res => res.json())
                    .then(pessoasFisicas => {
                        const selectPessoa = document.getElementById('nome');
                        // Limpa opções existentes, exceto a primeira
                        while (selectPessoa.options.length > 1) {
                            selectPessoa.remove(1);
                        }
                        pessoasFisicas.forEach(pessoa => {
                            const option = document.createElement('option');
                            option.value = pessoa.id;
                            option.textContent = `${pessoa.nome_completo} (${pessoa.cpf})`;
                            option.dataset.email = pessoa.email_principal;
                            option.dataset.telefone = pessoa.telefone_principal;
                            option.dataset.cpf = pessoa.cpf;
                            selectPessoa.appendChild(option);
                        });
                    })
                    .catch(() => {});
            }
            
            /**
             * Carrega dados da pessoa física selecionada
             */
            function carregarDadosPessoaFisica(pessoaId) {
                // Em produção, isso seria uma chamada para a API
                // Aqui estamos usando os dados armazenados no dataset das opções
                const option = document.querySelector(`#nome option[value="${pessoaId}"]`);
                
                if (option) {
                    document.getElementById('email').value = option.dataset.email || '';
                    document.getElementById('telefone').value = option.dataset.telefone || '';
                    document.getElementById('documento').value = option.dataset.cpf || '';
                    document.getElementById('idPessoaFisica').value = option.value || '';
                } else {
                    document.getElementById('idPessoaFisica').value = '';
                }
            }
            
            /**
             * Carrega lista de instituições (pessoas jurídicas) do banco de dados
             */
            function carregarInstituicoes() {
                // Buscar instituições reais da API
                fetch('/api/instituicoes')
                    .then(res => res.json())
                    .then(instituicoes => {
                        const selectInstituicao = document.getElementById('instituicao_nome');
                        while (selectInstituicao.options.length > 1) {
                            selectInstituicao.remove(1);
                        }
                        instituicoes.forEach(inst => {
                            const option = document.createElement('option');
                            option.value = inst.id;
                            option.textContent = `${inst.razao_social} (${inst.cnpj})`;
                            selectInstituicao.appendChild(option);
                        });
                    })
                    .catch(() => {});
                // Preenche o campo ID Pessoa Jurídica ao selecionar uma instituição
                const selectInstituicao = document.getElementById('instituicao_nome');
                if (selectInstituicao) {
                    selectInstituicao.addEventListener('change', function() {
                        document.getElementById('idPessoaJuridica').value = this.value || '';
                    });
                }
            }
            


            // Validação de força de senha
            const senhaInput = document.getElementById('senha');
            const confirmarSenhaInput = document.getElementById('confirmarSenha');
            const passwordStrength = document.getElementById('passwordStrength');
            const passwordStrengthText = document.getElementById('passwordStrengthText');

            senhaInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let color = '';
                let text = '';
                
                // Verifica comprimento
                if (password.length >= 8) {
                    strength += 1;
                }
                
                // Verifica letras maiúsculas
                if (password.match(/[A-Z]/)) {
                    strength += 1;
                }
                
                // Verifica letras minúsculas
                if (password.match(/[a-z]/)) {
                    strength += 1;
                }
                
                // Verifica números
                if (password.match(/[0-9]/)) {
                    strength += 1;
                }
                
                // Verifica caracteres especiais
                if (password.match(/[^A-Za-z0-9]/)) {
                    strength += 1;
                }
                
                // Define cor e texto com base na força
                switch (strength) {
                    case 0:
                    case 1:
                        color = '#dc3545'; // Vermelho
                        text = 'Muito fraca';
                        break;
                    case 2:
                        color = '#ffc107'; // Amarelo
                        text = 'Fraca';
                        break;
                    case 3:
                        color = '#fd7e14'; // Laranja
                        text = 'Média';
                        break;
                    case 4:
                        color = '#20c997'; // Verde claro
                        text = 'Forte';
                        break;
                    case 5:
                        color = '#198754'; // Verde
                        text = 'Muito forte';
                        break;
                }
                
                // Atualiza indicador visual
                passwordStrength.style.width = (strength * 20) + '%';
                passwordStrength.style.backgroundColor = color;
                passwordStrengthText.textContent = text;
                passwordStrengthText.style.color = color;
                
                // Verifica se as senhas coincidem
                if (confirmarSenhaInput.value) {
                    if (password !== confirmarSenhaInput.value) {
                        confirmarSenhaInput.setCustomValidity('As senhas não coincidem');
                    } else {
                        confirmarSenhaInput.setCustomValidity('');
                    }
                }
            });
            
            confirmarSenhaInput.addEventListener('input', function() {
                const password = senhaInput.value;
                const confirmPassword = this.value;
                if (password !== confirmPassword) {
                    this.setCustomValidity('As senhas não coincidem');
                    document.getElementById('confirmarSenhaFeedback').textContent = 'As senhas não coincidem.';
                    document.getElementById('confirmarSenhaFeedback').style.display = 'block';
                } else {
                    this.setCustomValidity('');
                    document.getElementById('confirmarSenhaFeedback').textContent = '';
                    document.getElementById('confirmarSenhaFeedback').style.display = 'none';
                }
            });

            // Verificação extra no submit para garantir que as senhas são iguais
            form.addEventListener('submit', function(event) {
                if (senhaInput.value !== confirmarSenhaInput.value) {
                    event.preventDefault();
                    event.stopPropagation();
                    confirmarSenhaInput.setCustomValidity('As senhas não coincidem');
                    document.getElementById('confirmarSenhaFeedback').textContent = 'As senhas não coincidem.';
                    document.getElementById('confirmarSenhaFeedback').style.display = 'block';
                    Swal.fire({
                        icon: 'warning',
                        title: 'Senhas diferentes',
                        text: 'As senhas informadas não coincidem. Corrija antes de enviar.'
                    });
                    return;
                } else {
                    confirmarSenhaInput.setCustomValidity('');
                    document.getElementById('confirmarSenhaFeedback').textContent = '';
                    document.getElementById('confirmarSenhaFeedback').style.display = 'none';
                }
            }, true);
            
            // Validação visual: feedback de campos obrigatórios preenchidos
            Array.from(form.elements).forEach(function(el) {
                el.addEventListener('input', function() {
                    if (form.checkValidity()) {
                        form.classList.add('is-valid-form');
                    } else {
                        form.classList.remove('is-valid-form');
                    }
                });
            });

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                // Limpa e exibe a área de logs somente agora
                logArea.innerHTML = '';
                logArea.style.display = 'block';
                log('--- Início do processo de solicitação de cadastro ---');
                log('Validando campos obrigatórios do formulário...');
                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    log('Formulário inválido: campos obrigatórios não preenchidos.', 'error');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Preencha todos os campos obrigatórios',
                        text: 'Verifique os campos destacados em vermelho e tente novamente.'
                    });
                    log('Processo interrompido devido a campos obrigatórios.', 'error');
                    return;
                }
                log('Campos obrigatórios validados com sucesso.');
                // Proteção anti-bot é feita apenas via anti-bot.js
                // Prepara os dados do formulário
                log('Montando dados do formulário para envio...');
                const formData = new FormData(form);
                const formDataObj = {};
                formData.forEach((value, key) => {
                    formDataObj[key] = value;
                });
                log('Dados brutos do formulário capturados.');
                // Garante que o campo ativo seja false
                formDataObj.ativo = false;
                log('Campo "ativo" definido como false.');
                formDataObj.pessoa_fisica_id = document.getElementById('idPessoaFisica').value;
                formDataObj.pessoa_juridica_id = document.getElementById('idPessoaJuridica').value;
                log('IDs de pessoa física e jurídica definidos.');
                // Remove campos não esperados pela API
                delete formDataObj.instituicao_nome;
                log('Campo "instituicao_nome" removido dos dados.');
                const camposRemover = ['nome', 'captcha', 'website', 'confirmarSenha', 'termo_privacidade', 'termo_uso', 'form_start_time', 'ativo', 'documento'];
                camposRemover.forEach(campo => {
                    if (campo in formDataObj) {
                        delete formDataObj[campo];
                        log(`Campo "${campo}" removido dos dados.`);
                    }
                });
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
                log('Botão de envio desabilitado e spinner exibido.');
                log('Enviando solicitação para a API...');
                // Envio real para a API
                fetch('/api/usuarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formDataObj)
                })
                .then(async response => {
                    log('Resposta recebida da API. Status: ' + response.status);
                    if (!response.ok) {
                        log('Processando resposta de erro da API...','error');
                        let err;
                        try {
                            err = await response.json();
                        } catch (e) {
                            err = { mensagem: 'Erro desconhecido ao processar resposta da API.' };
                        }
                        let msg = 'Erro ao enviar dados.';
                        let details = '';
                        if (err.erro === 'USUARIO_DUPLICADO') {
                            msg = 'Usuário já existe';
                            details = 'Você já possui um usuário com este tipo de acesso. Escolha outro tipo de usuário.';
                        } else if (err.erro === 'PESSOA_FISICA_NAO_ENCONTRADA') {
                            msg = 'Pessoa física não encontrada';
                            details = 'A pessoa física selecionada não foi encontrada no sistema.';
                        } else if (err.erro === 'PESSOA_JURIDICA_NAO_ENCONTRADA') {
                            msg = 'Instituição não encontrada';
                            details = 'A instituição selecionada não foi encontrada no sistema.';
                        } else if (err.erro === 'EMAIL_INVALIDO') {
                            msg = 'Email inválido';
                            details = 'O email informado não possui um formato válido.';
                        } else if (err.erro === 'DADOS_INVALIDOS' && err.campos_invalidos) {
                            msg = 'Dados inválidos';
                            details = '<ul style="margin-bottom:0;">';
                            for (const campo in err.campos_invalidos) {
                                details += `<li><strong>${campo}:</strong> ${err.campos_invalidos[campo]}</li>`;
                            }
                            details += '</ul>';
                        } else if (err.mensagem) {
                            msg = err.mensagem;
                            details = err.detalhes || '';
                        }
                        const errorHtml = details ? `${msg}<div class="error-details mt-2">${details}</div>` : msg;
                        log('Erro da API: ' + msg + (details ? ' - ' + details.replace(/<[^>]+>/g, '') : ''), 'error');
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro ao enviar solicitação',
                            html: errorHtml,
                            confirmButtonText: 'Entendi'
                        });
                        log('Processo interrompido devido a erro da API.', 'error');
                        throw new Error(msg);
                    }
                    log('Resposta da API indica sucesso. Processando dados de retorno...','success');
                    return response.json();
                })
                .then(data => {
                    log('Solicitação enviada com sucesso. Protocolo: ' + (data.protocolo || 'N/A'), 'success');
                    // Atualiza o texto do modal de sucesso com informações adicionais
                    if (data.protocolo) {
                        document.getElementById('protocoloSolicitacao').textContent = data.protocolo;
                        log('Protocolo atualizado no modal de sucesso.');
                    }
                    // Verifica se os emails foram enviados
                    if (data.notificacoes) {
                        const emailStatus = data.notificacoes.emailUsuario ? 'enviado' : 'não enviado';
                        document.getElementById('emailStatus').textContent = emailStatus;
                        log('Status do envio de email: ' + emailStatus);
                    }
                    // Exibe modal de sucesso
                    log('Exibindo modal de sucesso ao usuário.');
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    // Reseta formulário
                    form.reset();
                    form.classList.remove('was-validated');
                    form.classList.remove('is-valid-form');
                    // Limpa indicador de força de senha
                    passwordStrength.style.width = '0%';
                    passwordStrengthText.textContent = '';
                    log('Formulário e indicadores resetados.');
                })
                .catch(error => {
                    log('Erro no processo de solicitação: ' + error, 'error');
                })
                .finally(() => {
                    // Restaura botão
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-user-plus me-2"></i> Solicitar Acesso';
                    log('Botão de envio restaurado.');
                    log('--- Fim do processo de solicitação de cadastro ---');
                });
            });
        });
    </script>
</body>
</html>