<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Usuário - SIGMA-PLI | Módulo de Gerenciamento de Cadastros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/sistema_aplicacao_cores_pli.css">
    <style>
        .is-valid-form {
            box-shadow: 0 0 0 2px #19875444 !important;
        }
        .form-section {
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .form-section-header {
            background: var(--pli-azul-escuro);
            color: white;
            padding: 1rem;
            font-weight: 600;
        }
        .form-section-body {
            background: #fff;
            padding: 1.5rem;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            background-color: #e9ecef;
        }
        .password-strength.weak {
            background: linear-gradient(to right, #dc3545 0%, #dc3545 25%, #e9ecef 25%);
        }
        .password-strength.medium {
            background: linear-gradient(to right, #fd7e14 0%, #fd7e14 50%, #e9ecef 50%);
        }
        .password-strength.strong {
            background: linear-gradient(to right, #ffc107 0%, #ffc107 75%, #e9ecef 75%);
        }
        .password-strength.very-strong {
            background: linear-gradient(to right, #198754 0%, #198754 100%);
        }
        .password-strength-text {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
        }
        .password-strength-text:empty {
            display: none;
        }
        
        /* Garantir que o footer apareça */
        #footer-container {
            margin-top: auto;
            padding-top: 2rem;
        }
        
        .verificacao-seguranca-input {
            font-size: 1.1rem;
            font-weight: 500;
            display: inline-block;
        }
        .verificacao-seguranca-label {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-info p {
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <div id="navbar-container"></div>
    <script src="/static/js/navbar-loader.js"></script>

    <!-- Área Central -->
    <div class="flex-grow-1 py-5 pli-bg-gradient">
        <div class="container pli-main-content pli-max-width-600">

            <!-- Título da Página -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="mb-0 pli-title">
                        <i class="fas fa-user-plus me-2 text-pli-primary"></i>
                        Cadastro de Usuário
                    </h1>
                    <p class="text-muted">Solicite seu acesso ao sistema PLI</p>
                </div>
            </div>

            <!-- Alerta Informativo -->
            <div class="row justify-content-center mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Para solicitar acesso, é necessário cadastre-se primeiro como Pessoa Física e em seguida cadastrar a instituição (Pessoa Jurídica) à qual você está vinculado.
                    </div>
                </div>
            </div>

            <!-- Formulário -->
            <div class="row justify-content-center">
                <div class="col-12">
                    <form id="usuarioPublicForm" novalidate>
                        <!-- Dados Pessoais -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-id-card me-2"></i> Dados Pessoais
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="nome" class="form-label required-field">Nome Completo</label>
                                        <select class="form-select" id="nome" name="nome" required aria-describedby="nome-help">
                                            <option value="">Selecione uma pessoa física cadastrada</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione uma pessoa física.</div>
                                        <div id="nome-help" class="form-text">Selecione uma pessoa física já cadastrada no sistema.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="idPessoaFisica" class="form-label required-field">ID Pessoa Física</label>
                                        <input type="text" class="form-control" id="idPessoaFisica" name="pessoa_fisica_id" required readonly>
                                        <div class="invalid-feedback">O ID da pessoa física é obrigatório.</div>
                                        <div class="form-text">Este é o identificador único da pessoa física selecionada.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label required-field">Email</label>
                                        <input type="email" class="form-control" id="email" name="email" required readonly autocomplete="email">
                                        <div class="invalid-feedback">Por favor, informe um email válido.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="telefone" class="form-label required-field">Telefone</label>
                                        <input type="text" class="form-control" id="telefone" name="telefone" required readonly>
                                        <div class="invalid-feedback">Por favor, informe um telefone válido.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="documento" class="form-label required-field">CPF</label>
                                        <input type="text" class="form-control" id="documento" name="documento" required readonly>
                                        <div class="invalid-feedback">Por favor, informe um CPF válido.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados Profissionais -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-briefcase me-2"></i> Dados Profissionais
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="instituicao_nome" class="form-label required-field">Instituição</label>
                                        <select class="form-select" id="instituicao_nome" name="instituicao_nome" required>
                                            <option value="">Selecione uma instituição</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione uma instituição.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="idPessoaJuridica" class="form-label required-field">ID Pessoa Jurídica</label>
                                        <input type="text" class="form-control" id="idPessoaJuridica" name="pessoa_juridica_id" required readonly>
                                        <div class="invalid-feedback">O ID da pessoa jurídica é obrigatório.</div>
                                        <div class="form-text">Identificador único da instituição.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="departamento" class="form-label">Departamento</label>
                                        <input type="text" class="form-control" id="departamento" name="departamento">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cargo" class="form-label">Cargo</label>
                                        <input type="text" class="form-control" id="cargo" name="cargo">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email_institucional" class="form-label required-field">E-mail Institucional</label>
                                        <input type="email" class="form-control" id="email_institucional" name="email_institucional" required>
                                        <div class="invalid-feedback">Por favor, informe um e-mail institucional válido.</div>
                                        <div class="form-text">O nome de usuário será gerado automaticamente a partir deste e-mail.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="telefone_institucional" class="form-label">Telefone Institucional</label>
                                        <input type="text" class="form-control" id="telefone_institucional" name="telefone_institucional">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ramal_institucional" class="form-label">Ramal Institucional</label>
                                        <input type="text" class="form-control" id="ramal_institucional" name="ramal_institucional">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dados de Acesso -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-lock me-2"></i> Dados de Acesso
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="tipo_usuario" class="form-label required-field">Tipo de Usuário</label>
                                        <select class="form-select" id="tipo_usuario" name="tipo_usuario" required aria-describedby="tipo-usuario-help">
                                            <option value="">Selecione</option>
                                            <option value="ADMIN">Administrador</option>
                                            <option value="GESTOR">Gestor</option>
                                            <option value="ANALISTA">Analista</option>
                                            <option value="OPERADOR">Operador</option>
                                            <option value="VISUALIZADOR">Visualizador</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione um tipo de usuário.</div>
                                        <div id="tipo-usuario-help" class="form-text">
                                            Você pode ter até cinco usuários diferentes (um de cada tipo) com o mesmo CPF.
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="username" class="form-label required-field">Nome de Usuário</label>
                                        <input type="text" class="form-control" id="username" name="username" required readonly>
                                        <div class="invalid-feedback">Nome de usuário é obrigatório.</div>
                                        <div class="form-text">Gerado automaticamente a partir do e-mail institucional.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="senha" class="form-label required-field">Senha</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="senha" name="senha" required aria-describedby="toggleSenha" autocomplete="new-password">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleSenha" tabindex="-1" aria-label="Mostrar/ocultar senha"><i class="fa fa-eye"></i></button>
                                        </div>
                                        <div class="password-strength" id="passwordStrength"></div>
                                        <div class="password-strength-text" id="passwordStrengthText"></div>
                                        <div class="invalid-feedback" id="senhaFeedback">Por favor, crie uma senha forte.</div>
                                        <div class="form-text">
                                            A senha deve conter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e caracteres especiais.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confirmarSenha" class="form-label required-field">Confirmar Senha</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha" required aria-describedby="toggleConfirmarSenha" autocomplete="new-password">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarSenha" tabindex="-1" aria-label="Mostrar/ocultar senha"><i class="fa fa-eye"></i></button>
                                        </div>
                                        <div class="invalid-feedback" id="confirmarSenhaFeedback">As senhas não coincidem.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Termos e Condições -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-file-signature me-2"></i> Termos e Condições
                            </div>
                            <div class="form-section-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termoPrivacidade" name="termo_privacidade" required>
                                    <label class="form-check-label" for="termoPrivacidade">
                                        Li e concordo com a <a href="#" data-bs-toggle="modal" data-bs-target="#privacidadeModal">Política de Privacidade</a> *
                                    </label>
                                    <div class="invalid-feedback">Você deve concordar com a política de privacidade.</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termoUso" name="termo_uso" required>
                                    <label class="form-check-label" for="termoUso">
                                        Li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termosModal">Termos de Uso</a> *
                                    </label>
                                    <div class="invalid-feedback">Você deve concordar com os termos de uso.</div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <small>Ao solicitar acesso, você declara que as informações fornecidas são verdadeiras e está ciente de que o uso indevido do sistema pode resultar em sanções administrativas e legais.</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Verificação de Segurança -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-shield-alt me-2"></i> Verificação de Segurança
                            </div>
                            <div class="form-section-body text-center">
                                <div id="protection-container">
                                    <!-- Verificação de Segurança será inserida automaticamente aqui pelo AntiBotProtection -->
                                </div>
                            </div>
                        </div>

                        <!-- Finalização do Cadastro -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <i class="fas fa-user-plus me-2"></i> Solicitar Acesso
                            </div>
                            <div class="form-section-body">
                                <div class="d-flex gap-3">
                                    <button type="button" class="btn btn-light btn-lg flex-fill border-2" onclick="window.location.href='index.html'">
                                        <i class="fas fa-home me-2"></i> Voltar ao Início
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                        <i class="fas fa-user-plus me-2"></i> Solicitar Acesso
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success">
                        <i class="fas fa-check-circle me-2"></i> Solicitação Enviada com Sucesso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-check-circle text-success pli-icon-4rem"></i>
                    </div>
                    
                    <div class="alert alert-success">
                        <h4 class="alert-heading">Solicitação Recebida!</h4>
                        <p>Sua solicitação de acesso foi recebida com sucesso!</p>
                        <hr>
                        <p class="mb-0"><strong>Protocolo:</strong> <span id="protocoloSolicitacao">PLI-XXXXXXXX</span></p>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-envelope me-2"></i> Notificações
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><i class="fas fa-paper-plane me-2 text-primary"></i> Um email de confirmação foi <span id="emailStatus">enviado</span> para os endereços informados.</p>
                            <p><i class="fas fa-file-alt me-2 text-primary"></i> O comprovante da solicitação foi anexado ao email.</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tasks me-2"></i> Próximos Passos
                            </h5>
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li><strong>Etapa Atual:</strong> <span class="badge bg-success">Solicitação Recebida</span></li>
                                <li><strong>Próxima Etapa:</strong> <span class="badge bg-warning text-dark">Em Análise</span> - Sua solicitação será analisada pelos administradores ou gestores do sistema.</li>
                                <li><strong>Etapa Final:</strong> <span class="badge bg-info">Aprovação/Rejeição</span> - Você receberá um email com o resultado da análise.</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        O prazo médio para análise é de 2 dias úteis. Em caso de dúvidas, entre em contato pelo email <strong>pli.semil.sp@gmail.com</strong>.
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="index.html" class="btn btn-primary btn-lg px-4">
                        <i class="fas fa-home me-2"></i> Ir para Página Inicial
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="/static/js/services/api.js"></script>
    <script src="/static/js/components/form-validator.js"></script>
    <script src="/static/js/components/passwordToggle.js"></script>
    <script src="/static/js/components/anti-bot.js"></script>
    <script src="/static/js/feedback-system.js"></script>
    
    <script>
        // Mostrar/ocultar senha
        document.getElementById('toggleSenha').addEventListener('click', function() {
            const senhaInput = document.getElementById('senha');
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
                this.innerHTML = '<i class="fa fa-eye-slash"></i>';
            } else {
                senhaInput.type = 'password';
                this.innerHTML = '<i class="fa fa-eye"></i>';
            }
        });
        
        document.getElementById('toggleConfirmarSenha').addEventListener('click', function() {
            const confirmarSenhaInput = document.getElementById('confirmarSenha');
            if (confirmarSenhaInput.type === 'password') {
                confirmarSenhaInput.type = 'text';
                this.innerHTML = '<i class="fa fa-eye-slash"></i>';
            } else {
                confirmarSenhaInput.type = 'password';
                this.innerHTML = '<i class="fa fa-eye"></i>';
            }
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('usuarioPublicForm');
            
            // Inicializa proteção anti-bot
            let antiBotProtection;
            try {
                antiBotProtection = new AntiBotProtection('usuarioPublicForm');
                console.log('Proteção anti-bot inicializada com sucesso');
                
                // Mostrar feedback visual para o usuário
                setTimeout(() => {
                    const protectionContainer = document.getElementById('protection-container');
                    if (protectionContainer && protectionContainer.children.length > 0) {
                        const feedbackDiv = document.createElement('div');
                        feedbackDiv.className = 'alert alert-success mt-3';
                        feedbackDiv.innerHTML = '<i class="fas fa-shield-alt me-2"></i><strong>Sistema Seguro:</strong> Proteção anti-bot ativada';
                        protectionContainer.appendChild(feedbackDiv);
                        
                        // Remove o feedback após 5 segundos
                        setTimeout(() => {
                            if (feedbackDiv.parentNode) {
                                feedbackDiv.remove();
                            }
                        }, 5000);
                    }
                }, 1000);
            } catch (error) {
                console.error('Erro ao inicializar proteção anti-bot:', error);
                if (typeof showError !== 'undefined') {
                    showError('Erro de Segurança', 'Falha ao carregar proteção anti-bot. Recarregue a página.');
                }
            }
            
            // Máscaras e formatação
            setTimeout(function() {
                if (window.jQuery && $.fn.mask) {
                    $('#telefone_institucional').mask('(00) 00000-0000', {
                        placeholder: '(00) 00000-0000',
                        translation: {
                            '0': {pattern: /[0-9]/}
                        }
                    });
                    
                    $('#telefone').mask('(00) 00000-0000', {
                        placeholder: '(00) 00000-0000'
                    });
                    
                    $('#ramal_institucional').mask('0000', {
                        placeholder: 'Ramal'
                    });
                    
                    $('#documento').mask('000.000.000-00', {
                        placeholder: '000.000.000-00'
                    });
                    
                    $('#idPessoaFisica, #idPessoaJuridica').mask('0000000000', {
                        placeholder: 'ID'
                    });
                    
                    // Formatação de texto capitalizado
                    function formatarTextoCapitalizado(selector) {
                        $(selector).on('blur', function() {
                            const valor = $(this).val().trim();
                            if (valor) {
                                const preposicoes = ['da', 'de', 'do', 'das', 'dos', 'e', 'em', 'na', 'no', 'para', 'por', 'com'];
                                const palavrasFormatadas = valor.toLowerCase().split(' ').map((palavra, index) => {
                                    if (index > 0 && preposicoes.includes(palavra)) {
                                        return palavra;
                                    }
                                    return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                                });
                                $(this).val(palavrasFormatadas.join(' '));
                            }
                        });
                    }
                    
                    // Validação de força da senha
                    function validarForcaSenha() {
                        const senhaInput = document.getElementById('senha');
                        const senha = senhaInput.value;
                        const passwordStrength = document.getElementById('passwordStrength');
                        const passwordStrengthText = document.getElementById('passwordStrengthText');
                        const senhaFeedback = document.getElementById('senhaFeedback');
                        
                        // Critérios de validação
                        const requirements = {
                            length: senha.length >= 8,
                            upper: /[A-Z]/.test(senha),
                            lower: /[a-z]/.test(senha),
                            number: /\d/.test(senha),
                            special: /[!@#$%^&*(),.?":{}|<>]/.test(senha)
                        };
                        
                        const validCount = Object.values(requirements).filter(Boolean).length;
                        const isValid = Object.values(requirements).every(req => req);
                        
                        // Atualizar barra de força
                        if (passwordStrength) {
                            let strengthClass = '';
                            let strengthText = '';
                            
                            if (senha.length === 0) {
                                strengthClass = '';
                                strengthText = '';
                            } else if (validCount < 2) {
                                strengthClass = 'weak';
                                strengthText = 'Muito fraca';
                            } else if (validCount < 4) {
                                strengthClass = 'medium';
                                strengthText = 'Média';
                            } else if (validCount < 5) {
                                strengthClass = 'strong';
                                strengthText = 'Forte';
                            } else {
                                strengthClass = 'very-strong';
                                strengthText = 'Muito forte';
                            }
                            
                            passwordStrength.className = `password-strength ${strengthClass}`;
                            if (passwordStrengthText) {
                                passwordStrengthText.textContent = strengthText;
                            }
                        }
                        
                        // Atualizar validação do Bootstrap
                        if (senha.length > 0) {
                            if (isValid) {
                                senhaInput.classList.remove('is-invalid');
                                senhaInput.classList.add('is-valid');
                                if (senhaFeedback) {
                                    senhaFeedback.textContent = 'Senha válida!';
                                }
                            } else {
                                senhaInput.classList.remove('is-valid');
                                senhaInput.classList.add('is-invalid');
                                if (senhaFeedback) {
                                    senhaFeedback.textContent = 'A senha deve conter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e caracteres especiais.';
                                }
                            }
                        } else {
                            senhaInput.classList.remove('is-valid', 'is-invalid');
                        }
                        
                        return isValid;
                    }
                    
                    // Validação de confirmação de senha
                    function validarConfirmacaoSenha() {
                        const senhaInput = document.getElementById('senha');
                        const confirmarSenhaInput = document.getElementById('confirmarSenha');
                        const confirmarSenhaFeedback = document.getElementById('confirmarSenhaFeedback');
                        
                        const senha = senhaInput.value;
                        const confirmarSenha = confirmarSenhaInput.value;
                        
                        if (confirmarSenha.length > 0) {
                            if (senha === confirmarSenha) {
                                confirmarSenhaInput.classList.remove('is-invalid');
                                confirmarSenhaInput.classList.add('is-valid');
                                if (confirmarSenhaFeedback) {
                                    confirmarSenhaFeedback.textContent = 'Senhas coincidem!';
                                }
                                return true;
                            } else {
                                confirmarSenhaInput.classList.remove('is-valid');
                                confirmarSenhaInput.classList.add('is-invalid');
                                if (confirmarSenhaFeedback) {
                                    confirmarSenhaFeedback.textContent = 'As senhas não coincidem.';
                                }
                                return false;
                            }
                        } else {
                            confirmarSenhaInput.classList.remove('is-valid', 'is-invalid');
                            return false;
                        }
                    }
                    
                    formatarTextoCapitalizado('#departamento, #cargo');
                    
                    // Validação de email institucional em tempo real
                    $('#email_institucional').on('blur', function() {
                        const email = $(this).val().trim();
                        if (email) {
                            // Validação de formato
                            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                            
                            if (!emailPattern.test(email)) {
                                $(this).addClass('is-invalid');
                                if (typeof showError !== 'undefined') {
                                    showError('Email Inválido', 'Por favor, digite um endereço de email válido.');
                                }
                            } else {
                                $(this).removeClass('is-invalid').addClass('is-valid');
                                
                                // Gerar username automaticamente
                                const username = email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                                $('#username').val(username);
                            }
                        }
                    });
                    
                    // Validação de email pessoal
                    $('#email').on('blur', function() {
                        const email = $(this).val().trim();
                        if (email) {
                            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                        }
                    });
                    
                    // Validação de username
                    $('#username').on('input', function() {
                        const username = $(this).val().trim();
                        
                        // Remove caracteres especiais e transforma em minúsculo
                        const usernameFormatado = username.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                        $(this).val(usernameFormatado);
                        
                        if (username.length > 0 && username.length < 3) {
                            $(this).addClass('is-invalid');
                        } else if (username.length >= 3) {
                            $(this).removeClass('is-invalid').addClass('is-valid');
                        }
                    });
                    
                    // Limitação de caracteres em campos de texto
                    $('#senha, #confirmarSenha').on('input', function() {
                        validarForcaSenha();
                        validarConfirmacaoSenha();
                    });
                    
                    $('#observacoes, #descricao, #funcoes, #responsabilidades').on('input', function() {
                        const valor = $(this).val();
                        if (valor.length > 500) {
                            $(this).val(valor.substring(0, 500));
                        }
                    });
                    
                    console.log('Máscaras aplicadas com sucesso');
                } else {
                    console.warn('jQuery Mask não está disponível');
                }
            }, 500);
            
            // Função para carregar pessoas físicas
            async function carregarPessoasFisicas() {
                try {
                    const response = await fetch('/api/pessoas-fisicas');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const pessoas = await response.json();
                    
                    const select = document.getElementById('nome');
                    select.innerHTML = '<option value="">Selecione uma pessoa física cadastrada</option>';
                    
                    pessoas.forEach(pessoa => {
                        const option = document.createElement('option');
                        option.value = pessoa.id;
                        option.textContent = `${pessoa.nome_completo} - ${pessoa.cpf}`;
                        option.dataset.email = pessoa.email_principal;
                        option.dataset.telefone = pessoa.telefone_principal;
                        option.dataset.cpf = pessoa.cpf;
                        select.appendChild(option);
                    });
                    
                    console.log(`${pessoas.length} pessoas físicas carregadas`);
                    return pessoas;
                } catch (error) {
                    console.error('Erro ao carregar pessoas físicas:', error);
                    if (typeof showError !== 'undefined') {
                        showError('Erro no Carregamento', 'Erro ao carregar pessoas físicas: ' + error.message);
                    }
                    throw error;
                }
            }
            
            // Função para carregar instituições
            async function carregarInstituicoes() {
                try {
                    const response = await fetch('/api/instituicoes');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const instituicoes = await response.json();
                    
                    const select = document.getElementById('instituicao_nome');
                    select.innerHTML = '<option value="">Selecione uma instituição</option>';
                    
                    instituicoes.forEach(instituicao => {
                        const option = document.createElement('option');
                        option.value = instituicao.id;
                        option.textContent = `${instituicao.razao_social} - ${instituicao.cnpj}`;
                        select.appendChild(option);
                    });
                    
                    console.log(`${instituicoes.length} instituições carregadas`);
                    return instituicoes;
                } catch (error) {
                    console.error('Erro ao carregar instituições:', error);
                    if (typeof showError !== 'undefined') {
                        showError('Erro no Carregamento', 'Erro ao carregar instituições: ' + error.message);
                    }
                    throw error;
                }
            }
            
            // Carrega pessoas físicas e instituições após definir as funções
            Promise.all([
                carregarPessoasFisicas(),
                carregarInstituicoes()
            ]).then(([pessoasFisicas, instituicoes]) => {
                // Habilita o formulário após carregar as listas
                const submitButton = document.querySelector('button[type="submit"]');
                const allInputs = form.querySelectorAll('input, select, textarea');
                
                // Remove disabled dos campos se existir
                allInputs.forEach(input => {
                    if (input.hasAttribute('disabled') && input.id !== 'documento' && input.id !== 'telefone') {
                        input.removeAttribute('disabled');
                    }
                });
                
                // Habilita o botão de submit
                if (submitButton) {
                    submitButton.removeAttribute('disabled');
                }
                
                console.log('Formulário habilitado após carregamento das listas');
                
                // Feedback de progresso similar à página de pessoa física
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';
                progressContainer.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show">
                        <h5><i class="fas fa-check-circle me-2"></i>Sistema Inicializado com Sucesso!</h5>
                        <div class="progress-info">
                            <p class="mb-2"><i class="fas fa-shield-alt me-2"></i><strong>Proteção Anti-Bot:</strong> Ativada</p>
                            <p class="mb-2"><i class="fas fa-users me-2"></i><strong>Pessoas Físicas:</strong> ${pessoasFisicas.length} registros carregados</p>
                            <p class="mb-2"><i class="fas fa-building me-2"></i><strong>Instituições:</strong> ${instituicoes.length} registros carregados</p>
                            <p class="mb-0"><i class="fas fa-check me-2"></i><strong>Status:</strong> Formulário disponível para preenchimento</p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Insere o feedback após o título
                const titleSection = document.querySelector('.row.mb-4');
                if (titleSection && titleSection.parentNode) {
                    titleSection.parentNode.insertBefore(progressContainer, titleSection.nextSibling);
                    
                    // Remove o feedback após 8 segundos
                    setTimeout(() => {
                        if (progressContainer.parentNode) {
                            progressContainer.remove();
                        }
                    }, 8000);
                }
            }).catch(error => {
                console.error('Erro ao carregar listas:', error);
                if (typeof showError !== 'undefined') {
                    showError('Erro', 'Falha ao carregar listas. Recarregue a página para tentar novamente.');
                } else {
                    console.error('Função showError não está disponível');
                }
            });
            
            // Event listeners para seleção de pessoa física
            document.getElementById('nome').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedOption.value) {
                    // Preenche campos automaticamente
                    document.getElementById('idPessoaFisica').value = selectedOption.value;
                    document.getElementById('email').value = selectedOption.dataset.email || '';
                    document.getElementById('telefone').value = selectedOption.dataset.telefone || '';
                    document.getElementById('documento').value = selectedOption.dataset.cpf || '';
                    
                    // Marca campos como válidos
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    // Limpa campos
                    document.getElementById('idPessoaFisica').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('telefone').value = '';
                    document.getElementById('documento').value = '';
                    
                    // Remove validação
                    this.classList.remove('is-valid');
                }
            });
            
            // Event listener para seleção de instituição
            document.getElementById('instituicao_nome').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedOption.value) {
                    document.getElementById('idPessoaJuridica').value = selectedOption.value;
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    document.getElementById('idPessoaJuridica').value = '';
                    this.classList.remove('is-valid');
                }
            });
            
            // Submissão do formulário
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processando...';
                }
                
                try {
                    // Validação do formulário
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        throw new Error('Por favor, preencha todos os campos obrigatórios corretamente.');
                    }
                    
                    // Verifica proteção anti-bot
                    if (antiBotProtection && !antiBotProtection.validate()) {
                        throw new Error('Falha na verificação de segurança. Recarregue a página e tente novamente.');
                    }
                    
                    // Coleta dados do formulário
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    
                    // Submete dados
                    const response = await fetch('/api/usuarios', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Erro ao processar solicitação');
                    }
                    
                    // Sucesso
                    if (typeof showSuccess !== 'undefined') {
                        showSuccess('Sucesso!', 'Solicitação de acesso enviada com sucesso!');
                    }
                    
                    // Atualiza modal de sucesso
                    if (result.protocolo) {
                        document.getElementById('protocoloSolicitacao').textContent = result.protocolo;
                    }
                    
                    if (result.notificacoes) {
                        const emailStatus = result.notificacoes.emailUsuario ? 'enviado' : 'não enviado';
                        document.getElementById('emailStatus').textContent = emailStatus;
                    }
                    
                    // Exibe modal de sucesso
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                    // Reseta formulário
                    form.reset();
                    form.classList.remove('was-validated');
                    form.classList.remove('is-valid-form');
                    
                } catch (error) {
                    console.error('Erro na submissão:', error);
                    if (typeof showError !== 'undefined') {
                        showError('Erro', error.message);
                    } else {
                        alert('Erro: ' + error.message);
                    }
                } finally {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-user-plus me-2"></i> Solicitar Acesso';
                    }
                }
            });
            
        }); // Fim do DOMContentLoaded
    </script>

    <!-- Footer Oficial -->
    <div id="footer-container"></div>
    <script src="/static/js/footer-loader.js"></script>
</body>
</html>
